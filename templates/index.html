<!--
MIT License

Copyright (c) [2024] [Ashwin Natarajan]

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.
*/
-->

<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title id="pageTitle">Pits n' Giggles</title>
        <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Bangers&display=swap" rel="stylesheet">
        <style>
            body {
                font-family: 'Roboto', sans-serif;
                margin: 0;
                padding: 0;
                background-color: #000; /* Black background */
                color: #fdd835; /* Gold text */
                position: relative;
            }

            .top-section {
                display: flex;
                justify-content: space-around;
                align-items: stretch;
                gap: 20px;
                margin-top: 20px;
                max-height: 300px;
                overflow: hidden;
                margin-bottom: 1px; /* Adjust the margin-bottom as needed */
            }

            .weather-box, .race-info-box, .time-box {
                flex: 1;
                padding: 1px;
                background-color: #2e2e2e; /* Dark grey for Gotham feel */
                border: 2px solid #fdd835; /* Highlighted border in gold */
                border-radius: 10px;
                color: #fdd835; /* Text in gold */
                font-size: 22px;
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 1px;
                line-height: 1;
            }

            .race-info-box {
                line-height: 0.5;
            }

            table {
                width: 100%;
                table-layout: fixed;
                margin: 20px 0;
                background-color: #000; /* Black background */
                color: #fdd835; /* Gold text */
                border-spacing: 0;
                font-size: 26px;
            }

            th, td {
                padding: 10px;
                text-align: center;
                border-bottom: 1px solid #2e2e2e; /* Dark grey row separation */
            }

            th {
                background-color: #2e2e2e; /* Dark grey header background */
                color: #fdd835; /* Gold header text */
                font-weight: 700;
            }

            tbody tr:nth-child(even) {
                background-color: #1a1a1a; /* Darker shade for even rows */
            }

            .player-row td {
                font-weight: bold;
                border-color: #fdd835; /* Gold border */
            }

            .player-row td:first-child {
                border-left: 2px solid #fdd835; /* Left border on the first cell */
            }

            .player-row td:last-child {
                border-right: 2px solid #fdd835; /* Right border on the last cell */
            }

            .player-row td {
                border-top: 2px solid #fdd835 !important; /* Top border on all cells */
                border-bottom: 2px solid #fdd835 !important; /* Bottom border on all cells */
            }

            .fastest-lap {
                background-color: #E829F1 !important; /* Purple for fastest lap */
                color: #fff !important; /* White text for contrast */
            }

            .dnf {
                background-color: #771010 !important; /* Red for DNF */
                color: #fff !important; /* White text for contrast */
            }

            .dsq {
                background-color : #000000 !important; /* Black for DSQ */
                color: #fff !important; /* White text for contrast */
            }

            .drs-active {
                color: #28a745; /* Green font color for DRS active, no background change */
            }

            /* Remove link styling */
            .motivationLink {
                color: #fdd835; /* Text in gold */
            }
        </style>
    <script src="https://www.youtube.com/iframe_api"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>
</head>
<body>

    <div class="top-section">
        <div class="weather-box">
            <!-- Weather table -->
            <table id="weatherTable">
                <thead>
                    <tr>
                        <th>Time Offset</th>
                        <th>Rain Probability</th>
                        <th>Weather</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <div class="race-info-box">
            <h2 id="tableTitle">F1 Telemetry Live</h2>
            <p id="trackTemperature">Track Temperature: </p>
            <p id="lapInformation">Lap: </p>
            <p id="safetyCarStatus">Safety Car Status: </p>
            <p><a href="javascript:void(0);" id="saveTelemetryLink" class="motivationLink">Save telemetry packet capture</a></p>
        </div>
        <div class="time-box">
            <p id="localTime">Local Time: </p>
            <p id="fastestLapOverall">Fastest Lap Overall: </p>
            <p id="pitSpeedLimit">Pit Lane Speed Limit: </p>
            <a href="javascript:void(0);" id="motivationLink" class="motivationLink">Click here for motivation</a>
        </div>
    </div>

    <!-- YouTube iframe for audio, set to play when the link is clicked -->
    <iframe id="youtubeAudio" class="youtube-audio" width="0" height="0" src="https://www.youtube.com/embed/2L7Qm2hBJ6o?start=38&enablejsapi=1" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>

    <table id="liveTable">
        <thead>
            <tr>
                <th>Position</th>
                <th>Name</th>
                <th>Team</th>
                <th>Delta</th>
                <th>ERS</th>
                <th>Best</th>
                <th>Last</th>
                <th>Tyre Info</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <script>
        var player; // Define YT player

        function onYouTubeIframeAPIReady() {
            player = new YT.Player('youtubeAudio', {
                events: {
                    'onReady': onPlayerReady
                }
            });
        }

        function onPlayerReady(event) {
            var motivationLink = document.getElementById("motivationLink");
            motivationLink.addEventListener("click", playAudio);

            // Simulate a click to auto play the video when the page loads
            motivationLink.click();
        }

        function playAudio() {
            // Play the audio
            player.playVideo();

            // Set a timeout to stop the audio after 5000 milliseconds (5 seconds)
            setTimeout(stopAudio, 5000);
        }

        function stopAudio() {
            // Pause the audio
            player.pauseVideo();
        }

        function fetchDataAndDisplay() {
            fetch('/telemetry-info')
            .then(response => response.json())
            .then(data => {
                updateTable(data["table-entries"]);
                updateGlobalInfo(data["circuit"], data["event-type"], data["track-temperature"], data["current-lap"],
                    data["total-laps"], data["safety-car-status"], data["fastest-lap-overall"], data["pit-speed-limit"]);
                updateWeatherTable(data["weather-forecast-samples"])
            })
            .catch(error => {
                console.error('Error fetching data:', error);
            });
        }

        function updateWeatherTable(weatherData) {
            const weatherTableBody = document.querySelector('#weatherTable tbody');
            weatherTableBody.innerHTML = '';

            weatherData.forEach(data => {
                const row = weatherTableBody.insertRow();
                row.insertCell().textContent = data["time-offset"];
                row.insertCell().textContent = data["rain-probability"];
                row.insertCell().textContent = data["weather"];
            });
        }

        function updateTable(entries) {
            const tableBody = document.querySelector('#liveTable tbody');
            tableBody.innerHTML = '';

            entries.forEach(entry => {
                const row = tableBody.insertRow();

                row.insertCell().textContent = entry["position"];
                row.insertCell().textContent = entry["name"];
                row.insertCell().textContent = entry["team"];
                row.insertCell().textContent = entry["delta"];
                row.insertCell().textContent = entry["ers"];
                row.insertCell().textContent = entry["best"];
                row.insertCell().textContent = entry["last"];
                const tyreInfoCell = row.insertCell();
                tyreInfoCell.innerHTML = `${entry["average-tyre-wear"]}<br>` +
                        `${entry["tyre-age"]} laps ` + `(${entry["num-pitstops"]} pit)<br>` +
                        `${entry["tyre-compound"]}`;

                row.className = '';
                if (entry["is-fastest"]) {
                    console.log("Fastest lap: ", entry["name"]);
                    row.classList.add('fastest-lap');
                }

                switch (entry["dnf-status"]) {
                    case "DNF":
                        row.classList.add('dnf');
                        console.log("DNF: ", entry["name"]);
                        break;
                    case "DSQ":
                        row.classList.add('dsq');
                        console.log("DSQ: ", entry["name"]);
                        break;
                    // Add more cases if needed
                    default:
                        // Default case if none of the cases match
                }

                if (entry["is-player"]) {
                    row.classList.add('player-row'); // Apply the player-row class to the row
                    console.log("Player: ", entry["name"]);
                }

                // Fix for DRS active styling
                if (entry["drs"] === true) {
                    Array.from(row.cells).forEach(cell => cell.classList.add('drs-active'));
                    console.log("DSR: ", entry["name"]);
                }
            });
        }

        function updateGlobalInfo(circuit, event_type, track_temp, curr_lap, total_laps,
            safety_car_status, fastest_lap, pit_speed_limit) {

            document.getElementById('tableTitle').textContent = `${event_type} - ${circuit}`;
            document.getElementById('trackTemperature').textContent = `Track Temperature: ${track_temp}°C`;
            document.getElementById('lapInformation').textContent = `Lap: ${curr_lap}/${total_laps}`;
            document.getElementById('safetyCarStatus').textContent = `Safety Car Status: ${safety_car_status}`;
            document.getElementById('fastestLapOverall').textContent = `Fastest Lap Overall: ${fastest_lap}`;
            document.getElementById('pitSpeedLimit').textContent = `Pit Lane Speed Limit: ${pit_speed_limit} km/h`;

        }
        function updateLocalTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString(); // Converts the current time to a string using the local time convention
            document.getElementById('localTime').textContent = `Local Time: ${timeString}`;
        }

        function formatFileSize(bytes) {
            const sizes = ['Bytes', 'kB', 'MB', 'GB', 'TB'];

            if (bytes === 0) return '0 Byte';

            const i = parseInt(Math.floor(Math.log(bytes) / Math.log(1024)));

            // Dynamically determine the appropriate unit based on the file size
            const sizeUnit = sizes[Math.min(i, sizes.length - 1)];

            // Calculate the size in the determined unit
            const formattedSize = Math.round((bytes / Math.pow(1024, i)) * 100) / 100;

            return `${formattedSize} ${sizeUnit}`;
        }
        document.getElementById("saveTelemetryLink").addEventListener("click", function () {
            // Make an HTTP request when the link is clicked
            fetch('/save-telemetry-capture')
                .then(response => response.json())
                .then(data => {
                    // Process the data received from the server
                    console.log('Telemetry Capture Details:', data);

                    if (data['status-code'] === 'SUCCESS') {
                        // Format file size in a human-readable format
                        const formattedFileSize = formatFileSize(data['num-bytes']);

                        // Add commas to the number of packets
                        const numPacketsWithCommas = data['num-packets'].toLocaleString();

                        // If successful, display a success message
                        Swal.fire({
                            icon: 'success',
                            title: 'Telemetry captured!',
                            html: `Written to file: ${data['file-name']}.<br>${numPacketsWithCommas} packets written.<br>File size: ${formattedFileSize}.`,
                        });
                    } else if (data['status-code'] === 'DISABLED') {
                        // Handle DISABLED status
                        Swal.fire({
                            icon: 'info',
                            title: 'Telemetry capture is disabled!',
                            text: 'Please enable telemetry capture.',
                        });
                    } else {
                        // If unsuccessful, display an error message with response details
                        if (data["num-packets"] === 0) {
                            Swal.fire({
                                icon: 'error',
                                title: 'Error capturing telemetry!',
                                text: 'There is no data available to write to file',
                            });
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'Error capturing telemetry!',
                                text: JSON.stringify(data),
                            });
                        }
                    }
                })
                .catch(error => {
                    // If an error occurs during the HTTP request, display an error message
                    console.error('Error fetching telemetry capture details:', error);
                    Swal.fire({
                        icon: 'error',
                        title: 'Error fetching telemetry capture details!',
                        text: 'Please check the console for more information.',
                    });
                });
        });


        setInterval(updateLocalTime, 1000); // Update the time every second
        setInterval(fetchDataAndDisplay, 200); // Fetch data every 200 milliseconds
    </script>
</body>
</html>
