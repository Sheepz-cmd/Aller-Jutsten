<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title id="pageTitle">Pits n' Giggles</title>
        <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Bangers&display=swap" rel="stylesheet">
        <style>
            body {
                font-family: 'Roboto', sans-serif;
                margin: 0;
                padding: 0;
                background-color: #000; /* Black background */
                color: #fdd835; /* Gold text */
                position: relative;
            }

            .top-section {
                display: flex;
                justify-content: space-around;
                align-items: stretch;
                gap: 20px;
                margin-top: 20px;
                max-height: 300px;
                overflow: hidden;
                margin-bottom: 1px; /* Adjust the margin-bottom as needed */
            }

            .weather-box, .race-info-box, .time-box {
                flex: 1;
                padding: 1px;
                background-color: #2e2e2e; /* Dark grey for Gotham feel */
                border: 2px solid #fdd835; /* Highlighted border in gold */
                border-radius: 10px;
                color: #fdd835; /* Text in gold */
                font-size: 22px;
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 1px;
                line-height: 1;
            }

            .race-info-box {
                line-height: 0.5;
            }

            table {
                width: 100%;
                table-layout: fixed;
                margin: 20px 0;
                background-color: #000; /* Black background */
                color: #fdd835; /* Gold text */
                border-spacing: 0;
                font-size: 26px;
            }

            th, td {
                padding: 10px;
                text-align: center;
                border-bottom: 1px solid #2e2e2e; /* Dark grey row separation */
            }

            th {
                background-color: #2e2e2e; /* Dark grey header background */
                color: #fdd835; /* Gold header text */
                font-weight: 700;
            }

            tbody tr:nth-child(even) {
                background-color: #1a1a1a; /* Darker shade for even rows */
            }

            .player-row td {
                font-weight: bold;
                border-color: #fdd835; /* Gold border */
            }

            .player-row td:first-child {
                border-left: 2px solid #fdd835; /* Left border on the first cell */
            }

            .player-row td:last-child {
                border-right: 2px solid #fdd835; /* Right border on the last cell */
            }

            .player-row td {
                border-top: 2px solid #fdd835; /* Top border on all cells */
                border-bottom: 2px solid #fdd835; /* Bottom border on all cells */
            }

            .fastest-lap {
                background-color: #E829F1; /* Purple for fastest lap */
                color: #fff; /* White text for contrast */
            }

            .dnf {
                background-color: #f12929; /* Red for DNF */
                color: #fff; /* White text for contrast */
            }

            .dsq {
                background-color: #000000; /* Black for DSQ */
                color: #fff; /* White text for contrast */
            }

            .drs-active {
                color: #28a745; /* Green font color for DRS active, no background change */
            }

            /* Remove link styling */
            .motivation-link {
                display: none;
            }
        </style>
    <script src="https://www.youtube.com/iframe_api"></script>
</head>
<body>

    <div class="top-section">
        <div class="weather-box">
            <!-- Weather table -->
            <table id="weatherTable">
                <thead>
                    <tr>
                        <th>Time Offset</th>
                        <th>Rain Probability</th>
                        <th>Weather</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <div class="race-info-box">
            <h2 id="tableTitle">F1 Telemetry Live</h2>
            <p id="trackTemperature">Track Temperature: </p>
            <p id="lapInformation">Lap: </p>
            <p id="safetyCarStatus">Safety Car Status: </p>
        </div>
        <div class="time-box">
            <p id="localTime">Local Time: </p>
            <p id="fastestLapOverall">Fastest Lap Overall: </p>
            <a href="javascript:void(0);" id="motivationLink">Click here for motivation</a>
        </div>
    </div>

    <!-- YouTube iframe for audio, set to play when the link is clicked -->
    <iframe id="youtubeAudio" class="youtube-audio" width="0" height="0" src="https://www.youtube.com/embed/2L7Qm2hBJ6o?start=38&enablejsapi=1" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>

    <table id="liveTable">
        <thead>
            <tr>
                <th>Position</th>
                <th>Name</th>
                <th>Team</th>
                <th>Delta</th>
                <th>ERS</th>
                <th>Best</th>
                <th>Last</th>
                <th>Tyre Info</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <script>
        var player; // Define YT player

        function onYouTubeIframeAPIReady() {
            player = new YT.Player('youtubeAudio', {
                events: {
                    'onReady': onPlayerReady
                }
            });
        }

        function onPlayerReady(event) {
            var motivationLink = document.getElementById("motivationLink");
            motivationLink.addEventListener("click", playAudio);

            // Simulate a click to auto play the video when the page loads
            motivationLink.click();
        }

        function playAudio() {
            // Play the audio
            player.playVideo();

            // Set a timeout to stop the audio after 5000 milliseconds (5 seconds)
            setTimeout(stopAudio, 5000);
        }

        function stopAudio() {
            // Pause the audio
            player.pauseVideo();
        }

        function fetchDataAndDisplay() {
            fetch('/telemetry-info')
            .then(response => response.json())
            .then(data => {
                updateTable(data["table-entries"]);
                updateGlobalInfo(data["circuit"], data["event-type"], data["track-temperature"], data["current-lap"],
                    data["total-laps"], data["safety-car-status"], data["fastest-lap-overall"]);
                updateWeatherTable(data["weather-forecast-samples"])
            })
            .catch(error => {
                console.error('Error fetching data:', error);
            });
        }

        function updateWeatherTable(weatherData) {
            const weatherTableBody = document.querySelector('#weatherTable tbody');
            weatherTableBody.innerHTML = '';

            weatherData.forEach(data => {
                const row = weatherTableBody.insertRow();
                row.insertCell().textContent = data["time-offset"];
                row.insertCell().textContent = data["rain-probability"];
                row.insertCell().textContent = data["weather"];
            });
        }

        function updateTable(entries) {
            const tableBody = document.querySelector('#liveTable tbody');
            tableBody.innerHTML = '';

            entries.forEach(entry => {
                const row = tableBody.insertRow();

                row.insertCell().textContent = entry["position"];
                row.insertCell().textContent = entry["name"];
                row.insertCell().textContent = entry["team"];
                row.insertCell().textContent = entry["delta"];
                row.insertCell().textContent = entry["ers"];
                row.insertCell().textContent = entry["best"];
                row.insertCell().textContent = entry["last"];
                const tyreInfoCell = row.insertCell();
                tyreInfoCell.innerHTML = `${entry["average-tyre-wear"]}<br>` +
                        `${entry["tyre-age"]} laps ` + `(${entry["num-pitstops"]} pit)<br>` +
                        `${entry["tyre-compound"]}`;

                if (entry["is-fastest"]) {
                    row.classList.add('fastest-lap');
                }

                switch (entry["dnf-status"]) {
                    case "DNF":
                        row.classList.add('dnf');
                        break;
                    case "DSQ":
                        row.classList.add('dsq');
                        break;
                    // Add more cases if needed
                    default:
                        // Default case if none of the cases match
                }

                if (entry["is-player"]) {
                    row.classList.add('player-row'); // Apply the player-row class to the row
                }

                // Fix for DRS active styling
                if (entry["drs"] === true) {
                    Array.from(row.cells).forEach(cell => cell.classList.add('drs-active'));
                }
            });
        }

        function updateGlobalInfo(circuit, event_type, track_temp, curr_lap, total_laps, safety_car_status, fastest_lap) {
            document.getElementById('tableTitle').textContent = `${event_type} - ${circuit}`;
            document.getElementById('trackTemperature').textContent = `Track Temperature: ${track_temp}Â°C`;
            document.getElementById('lapInformation').textContent = `Lap: ${curr_lap}/${total_laps}`;
            document.getElementById('safetyCarStatus').textContent = `Safety Car Status: ${safety_car_status}`;
            document.getElementById('fastestLapOverall').textContent = `Fastest Lap Overall: ${fastest_lap}`;
        }
        function updateLocalTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString(); // Converts the current time to a string using the local time convention
            document.getElementById('localTime').textContent = `Local Time: ${timeString}`;
        }

        setInterval(updateLocalTime, 1000); // Update the time every second
        setInterval(fetchDataAndDisplay, 200); // Fetch data every 200 milliseconds
    </script>
</body>
</html>
