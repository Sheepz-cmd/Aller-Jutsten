<!--
MIT License

Copyright (c) [2024] [Ashwin Natarajan]

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.
*/
-->

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle">Pits n' Giggles</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Bangers&display=swap"
        rel="stylesheet">
    <style>
        /* Your existing styles */
        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #000;
            /* Black background */
            color: #fdd835;
            /* Gold text */
            position: relative;
        }

        .top-section {
            display: flex;
            justify-content: space-around;
            align-items: stretch;
            gap: 20px;
            margin-top: 20px;
            max-height: 300px;
            overflow: hidden;
            margin-bottom: 1px;
            /* Adjust the margin-bottom as needed */
        }

        .weather-box,
        .race-info-box,
        .time-box {
            flex: 1;
            padding: 1px;
            background-color: #2e2e2e;
            /* Dark grey for Gotham feel */
            border: 2px solid #fdd835;
            /* Highlighted border in gold */
            border-radius: 10px;
            color: #fdd835;
            /* Text in gold */
            font-size: 22px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1px;
            line-height: 1;
        }

        .race-info-box {
            line-height: 0.5;
        }

        table {
            width: 100%;
            table-layout: fixed;
            margin: 20px 0;
            background-color: #000;
            /* Black background */
            color: #fdd835;
            /* Gold text */
            border-spacing: 0;
            font-size: 25.5px;
        }

        th,
        td {
            padding: 10px;
            text-align: center;
            border-bottom: 1px solid #2e2e2e;
            /* Dark grey row separation */
        }

        th {
            background-color: #2e2e2e;
            /* Dark grey header background */
            color: #fdd835;
            /* Gold header text */
            font-weight: 700;
        }

        tbody tr:nth-child(even) {
            background-color: #1a1a1a;
            /* Darker shade for even rows */
        }

        .player-row td {
            font-weight: bold;
            border-color: #fdd835;
            /* Gold border */
        }

        .player-row td:first-child {
            border-left: 2px solid #fdd835;
            /* Left border on the first cell */
        }

        .player-row td:last-child {
            border-right: 2px solid #fdd835;
            /* Right border on the last cell */
        }

        .player-row td {
            border-top: 2px solid #fdd835 !important;
            /* Top border on all cells */
            border-bottom: 2px solid #fdd835 !important;
            /* Bottom border on all cells */
        }

        .fastest-lap {
            background-color: #E829F1 !important;
            /* Purple for fastest lap */
            color: #fff !important;
            /* White text for contrast */
        }

        .dnf {
            background-color: #771010 !important;
            /* Red for DNF */
            color: #fff !important;
            /* White text for contrast */
        }

        .dsq {
            background-color: #000000 !important;
            /* Black for DSQ */
            color: #fff !important;
            /* White text for contrast */
        }

        .drs-active {
            color: #28a745;
            /* Green font color for DRS active, no background change */
        }

        /* Remove link styling */
        .motivationLink {
            color: #fdd835;
            /* Text in gold */
            cursor: pointer;
            text-decoration: underline;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            /* Add background opacity */
            background-color: rgba(31, 30, 30, 0.9);
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #fefefe;
            padding: 20px;
            border-radius: 10px;
            text-align: center;

            /* Set width to 80% of the viewport width */
            width: 80%;

            /* Set max height to 80% of the viewport height */
            max-height: 80vh;

            /* Set overflow-y to auto to enable scrolling if the content exceeds the max height */
            overflow-y: auto;

            /* Change font color to a darker shade */
            color: #333;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #000;
        }

        .accordion {
            overflow: hidden;
            margin-bottom: 10px;
        }

        .accordion-title {
            background-color: #2e2e2e;
            /* Dark grey header background */
            color: #fdd835;
            /* Gold header text */
            cursor: pointer;
            padding: 14px;
            width: 100%;
            text-align: center;
            border: none;
            outline: none;
            transition: background-color 0.3s;
            font-size: larger;
            font-family: 'Roboto', sans-serif;
        }

        .accordion-content {
            padding: 0 18px;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.2s ease-out;
            width: 100%;
        }

        .accordion-content p {
            margin: 0;
            padding: 8px;
        }

    </style>
    <script src="https://www.youtube.com/iframe_api"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>
</head>

<body>

    <div class="top-section">
        <div class="weather-box">
            <!-- Weather table -->
            <table id="weatherTable">
                <thead>
                    <tr>
                        <th>Time Offset</th>
                        <th>Rain Probability</th>
                        <th>Weather</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <div class="race-info-box">
            <h2 id="tableTitle">F1 Telemetry Live</h2>
            <p id="trackTemperature">Track Temperature: </p>
            <p id="lapInformation">Lap: </p>
            <p id="safetyCarStatus" style="display: none;">Safety Car Status: </p>
            <p><a href="#" id="getOvertakeInfo" class="motivationLink" style="display: none;">Get Overtake Information</a></p>
            <p><a href="#" id="saveTelemetryLink" class="motivationLink">Save telemetry packet capture</a></p>
        </div>
        <div class="time-box">
            <p id="localTime" class="motivationLink">Local Time: </p>
            <p id="fastestLapOverall">Fastest Lap Overall: </p>
            <p id="pitSpeedLimit">Pit Lane Speed Limit: </p>
            <a href="javascript:void(0);" id="motivationLink" class="motivationLink">Click here for motivation</a>
        </div>
    </div>

    <!-- YouTube iframe for audio, set to play when the link is clicked -->
    <iframe id="youtubeAudio" class="youtube-audio" width="0" height="0"
        src="https://www.youtube.com/embed/2L7Qm2hBJ6o?start=38&enablejsapi=1" frameborder="0"
        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
        allowfullscreen></iframe>

    <table id="raceTable">
        <thead>
            <tr>
                <th>Position</th>
                <th>Name</th>
                <th>Team</th>
                <th>Delta</th>
                <th>ERS</th>
                <th>Best</th>
                <th>Last</th>
                <th>Tyre Info</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <div id="driverInfoModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeDriverInfoModal()">&times;</span>
            <h2 id="modalTitle">Driver Information</h2>
            <div id="modalContent" style="height: 90vh; overflow-y: auto;"></div>
        </div>
    </div>

    <script>
        var player; // Define YT player
        let is24HourFormat = true; // Initial format

        function onYouTubeIframeAPIReady() {
            player = new YT.Player('youtubeAudio', {
                events: {
                    'onReady': onPlayerReady
                }
            });
        }

        function onPlayerReady(event) {
            var motivationLink = document.getElementById("motivationLink");
            motivationLink.addEventListener("click", playAudio);

            // Simulate a click to auto play the video when the page loads
            motivationLink.click();
        }

        function playAudio() {
            // Play the audio
            player.playVideo();

            // Set a timeout to stop the audio after 5000 milliseconds (5 seconds)
            setTimeout(stopAudio, 5000);
        }

        function stopAudio() {
            // Pause the audio
            player.pauseVideo();
        }

        function formatFloatWithTwoDecimals(floatNumber) {
            if (typeof floatNumber !== 'number' || isNaN(floatNumber)) {
                console.error('Invalid input. Please provide a valid number.');
                return null;
            }

            // Use toFixed to round to two decimal places and convert to string
            return floatNumber.toFixed(2);
        }

        function formatFloatWithTwoDecimalsSigned(floatNumber) {
            if (typeof floatNumber !== 'number' || isNaN(floatNumber)) {
                console.error('Invalid input. Please provide a valid number.');
                return null;
            }

            // Use toFixed to round to two decimal places and convert to string
            const floatStr = floatNumber.toFixed(2);
            if (floatNumber >= 0.0) {
                return '+' + floatStr;
            } else {
                return floatStr;
            }
        }

        function fetchDataAndDisplay() {
            fetch('/telemetry-info')
                .then(response => response.json())
                .then(data => {
                    updateRaceTable(data["table-entries"]);
                    updateGlobalInfo(data["circuit"], data["event-type"], data["track-temperature"], data["current-lap"],
                        data["total-laps"], data["safety-car-status"], data["fastest-lap-overall"],
                        data["pit-speed-limit"], {{ packet_capture_enabled | tojson }});
                    updateWeatherTable(data["weather-forecast-samples"]);
                })
                .catch (error => {
            console.error('Error fetching data:', error);
        });
        }

        function updateWeatherTable(weatherData) {
            const weatherTableBody = document.querySelector('#weatherTable tbody');
            weatherTableBody.innerHTML = '';

            weatherData.forEach(data => {
                const row = weatherTableBody.insertRow();
                row.insertCell().textContent = data["time-offset"];
                row.insertCell().textContent = data["rain-probability"];
                row.insertCell().textContent = data["weather"];
            });
        }

        function updateRaceTable(entries) {
            const tableBody = document.querySelector('#raceTable tbody');
            tableBody.innerHTML = '';

            entries.forEach(entry => {
                const row = tableBody.insertRow();

                // Position column
                const positionCell = row.insertCell();
                positionCell.textContent = entry["position"];

                // Create a clickable link for the driver's name
                const nameCell = row.insertCell();
                const nameLink = document.createElement('a');
                nameLink.textContent = entry["name"];
                nameLink.href = '#'; // Set a placeholder href value

                // Get the computed style of the row and apply it to the hyperlink
                const rowStyles = window.getComputedStyle(row);
                nameLink.style.color = rowStyles.getPropertyValue('color');
                nameLink.style.fontFamily = rowStyles.getPropertyValue('font-family');

                nameLink.style.textDecoration = 'underline'; // Add standard link underline
                nameLink.onclick = function () {
                    handleDriverInfoClick(entry["index"]);
                };
                nameCell.appendChild(nameLink);

                row.insertCell().textContent = entry["team"];
                row.insertCell().textContent = entry["delta"];
                row.insertCell().textContent = entry["ers"];
                row.insertCell().textContent = entry["best"];
                row.insertCell().textContent = entry["last"];

                const tyreInfoCell = row.insertCell();
                tyreInfoCell.innerHTML = `${entry["average-tyre-wear"]}<br>` +
                    `${entry["tyre-age"]} lap(s) ` + `(${entry["num-pitstops"]} pit)<br>` +
                    `${entry["tyre-compound"]}`;

                row.className = '';
                if (entry["is-fastest"]) {
                    row.classList.add('fastest-lap');
                }

                switch (entry["dnf-status"]) {
                    case "DNF":
                        row.classList.add('dnf');
                        break;
                    case "DSQ":
                        row.classList.add('dsq');
                        break;
                    // Add more cases if needed
                    default:
                    // Default case if none of the cases match
                }

                if (entry["is-player"]) {
                    row.classList.add('player-row'); // Apply the player-row class to the row
                }

                // Fix for DRS active styling
                if (entry["drs"] === true) {
                    Array.from(row.cells).forEach(cell => cell.classList.add('drs-active'));
                }
            });
        }

        function handleDriverInfoClick(index) {
            fetch(`/driver-info?index=${index}`)
                .then(response => response.json())
                .then(data => {
                    openDriverInfoModal(data);
                })
                .catch(error => {
                    console.error('Error fetching driver info:', error);
                });
        }

        function openDriverInfoModal(data) {
            const modalContent = document.getElementById('modalContent');
            modalContent.innerHTML = '';

            function createAccordion(title, content) {
                const accordion = document.createElement('div');
                accordion.className = 'accordion';

                const accordionTitle = document.createElement('button');
                accordionTitle.className = 'accordion-title';
                accordionTitle.innerText = title;

                const accordionContent = document.createElement('div');
                accordionContent.className = 'accordion-content';
                accordionContent.appendChild(content);

                accordion.appendChild(accordionTitle);
                accordion.appendChild(accordionContent);

                // Add event listener for the accordion
                accordionTitle.addEventListener('click', function () {
                    accordion.classList.toggle('active');
                    if (accordion.classList.contains('active')) {
                        // Set max-height to the scrollHeight only if the accordion is being opened
                        accordionContent.style.maxHeight = accordionContent.scrollHeight + 'px';
                    } else {
                        // Set max-height to 0 when the accordion is being closed
                        accordionContent.style.maxHeight = null;
                    }
                });

                return accordion;
            }

            function createRow(label, value) {
                const row = document.createElement('p');
                row.innerHTML = `<strong>${label}:</strong> ${value}`;
                return row;
            }

            function formatComponentName(component) {
                // Convert component names to kebab-case
                return component.toLowerCase().replace(/\s+/g, '-');
            }

            function getCarDamageContent(data) {

                const carDamageContent = document.createElement('div');
                const carDamageTable = document.createElement('table');
                carDamageTable.classList.add('car-damage-table');
                const carDamageHeader = carDamageTable.createTHead();
                const carDamageHeaderRow = carDamageHeader.insertRow();
                carDamageHeaderRow.innerHTML = '<th>Component</th><th>Damage</th>';
                const carDamageBody = carDamageTable.createTBody();
                if ("car-damage" in data) {
                    // Front Left Wing Damage
                    const row1 = carDamageBody.insertRow();
                    row1.innerHTML = `
                        <td>Front Left Wing Damage</td>
                        <td>${formatFloatWithTwoDecimals(data["car-damage"]["front-left-wing-damage"])}%</td>
                    `;

                    // Front Right Wing Damage
                    const row2 = carDamageBody.insertRow();
                    row2.innerHTML = `
                        <td>Front Right Wing Damage</td>
                        <td>${formatFloatWithTwoDecimals(data["car-damage"]["front-right-wing-damage"])}%</td>
                    `;

                    // Rear Wing Damage
                    const row3 = carDamageBody.insertRow();
                    row3.innerHTML = `
                        <td>Rear Wing Damage</td>
                        <td>${formatFloatWithTwoDecimals(data["car-damage"]["rear-wing-damage"])}%</td>
                    `;
                } else {
                    const row = carDamageBody.insertRow();
                    row.innerHTML = '<td colspan="2">Car Damage data not available</td>';
                }
                carDamageContent.appendChild(createAccordion('Car Damage', carDamageTable));
                return carDamageContent;
            }

            function getTyreDamageContent(data) {

                const tyreDamageContent = document.createElement('div');
                const tyreDamageTable = document.createElement('table');
                tyreDamageTable.classList.add('tyre-damage-table');
                const tyreDamageHeader = tyreDamageTable.createTHead();
                const tyreDamageHeaderRow = tyreDamageHeader.insertRow();
                tyreDamageHeaderRow.innerHTML = '<th>Tyre</th><th>Damage</th>';
                const tyreDamageBody = tyreDamageTable.createTBody();
                if ("car-damage" in data) {
                    // Front Left Tyre Damage
                    const row1 = tyreDamageBody.insertRow();
                    row1.innerHTML = `<td>Front Left Tyre Damage</td><td>${formatFloatWithTwoDecimals(data["car-damage"]["tyres-damage"][2])}%</td>`;

                    // Front Right Tyre Damage
                    const row2 = tyreDamageBody.insertRow();
                    row2.innerHTML = `<td>Front Right Tyre Damage</td><td>${formatFloatWithTwoDecimals(data["car-damage"]["tyres-damage"][3])}%</td>`;

                    // Rear Left Tyre Damage
                    const row3 = tyreDamageBody.insertRow();
                    row3.innerHTML = `<td>Rear Left Tyre Damage</td><td>${formatFloatWithTwoDecimals(data["car-damage"]["tyres-damage"][0])}%</td>`;

                    // Rear Right Tyre Damage
                    const row4 = tyreDamageBody.insertRow();
                    row4.innerHTML = `<td>Rear Right Tyre Damage</td><td>${formatFloatWithTwoDecimals(data["car-damage"]["tyres-damage"][1])}%</td>`;
                } else {
                    const row = tyreDamageBody.insertRow();
                    row.innerHTML = '<td colspan="2">Tyre Damage data not available</td>';
                }
                tyreDamageContent.appendChild(createAccordion('Tyre Damage', tyreDamageTable));
                return tyreDamageContent;
            }

            function getTyreWearContent(data) {

                const tyreWearContent = document.createElement('div');
                const tyreWearTable = document.createElement('table');
                tyreWearTable.classList.add('tyre-damage-table');
                const tyreWearHeader = tyreWearTable.createTHead();
                const tyreWearHeaderRow = tyreWearHeader.insertRow();
                tyreWearHeaderRow.innerHTML = '<th>Tyre</th><th>Wear</th>';
                const tyreWearBody = tyreWearTable.createTBody();
                if ("car-damage" in data) {
                    // Front Left Tyre Wear
                    const row1 = tyreWearBody.insertRow();
                    row1.innerHTML = `<td>Front Left Tyre Wear</td><td>${formatFloatWithTwoDecimals(data["car-damage"]["tyres-wear"][2])}%</td>`;

                    // Front Right Tyre Wear
                    const row2 = tyreWearBody.insertRow();
                    row2.innerHTML = `<td>Front Right Tyre Wear</td><td>${formatFloatWithTwoDecimals(data["car-damage"]["tyres-wear"][3])}%</td>`;

                    // Rear Left Tyre Wear
                    const row3 = tyreWearBody.insertRow();
                    row3.innerHTML = `<td>Rear Left Tyre Wear</td><td>${formatFloatWithTwoDecimals(data["car-damage"]["tyres-wear"][0])}%</td>`;

                    // Rear Right Tyre Wear
                    const row4 = tyreWearBody.insertRow();
                    row4.innerHTML = `<td>Rear Right Tyre Wear</td><td>${formatFloatWithTwoDecimals(data["car-damage"]["tyres-wear"][1])}%</td>`;
                } else {
                    const row = tyreWearBody.insertRow();
                    row.innerHTML = '<td colspan="2">Tyre Wear data not available</td>';
                }
                tyreWearContent.appendChild(createAccordion('Tyre Wear', tyreWearTable));
                return tyreWearContent;
            }

            function getLapHistoryContent(data) {

                const lapHistoryContent = document.createElement('div');
                const lapHistoryTable = document.createElement('table');
                lapHistoryTable.classList.add('lap-history-table');

                const lapHistoryHeader = lapHistoryTable.createTHead();
                const headerRow = lapHistoryHeader.insertRow();
                headerRow.innerHTML = '<th>Lap</th><th>S1 Time</th><th>S2 Time</th><th>S3 Time</th><th>Total Time</th>';

                const lapHistoryBody = lapHistoryTable.createTBody();
                if ("session-history" in data) {
                    const lapHistoryData = data["session-history"]["lap-history-data"];
                    const bestLapNum = data["session-history"]["best-lap-time-lap-num"];
                    const bestSector1Num = data["session-history"]["best-sector-1-lap-num"];
                    const bestSector2Num = data["session-history"]["best-sector-2-lap-num"];
                    const bestSector3Num = data["session-history"]["best-sector-3-lap-num"];

                    lapHistoryData.forEach((lap, index) => {
                        const row = lapHistoryBody.insertRow();
                        const currentLapNum = index + 1;

                        row.innerHTML = `
                            <td>${currentLapNum}</td>
                            <td>${lap["sector-1-time-str"]}</td>
                            <td>${lap["sector-2-time-str"]}</td>
                            <td>${lap["sector-3-time-str"]}</td>
                            <td>${lap["lap-time-str"]}</td>
                        `;

                        // Check and mark green for best sector 1
                        if (currentLapNum === bestSector1Num) {
                            row.cells[1].style.color = '#32F129';
                        }

                        // Check and mark green for best sector 2
                        if (currentLapNum === bestSector2Num) {
                            row.cells[2].style.color = '#32F129';
                        }

                        // Check and mark green for best sector 3
                        if (currentLapNum === bestSector3Num) {
                            row.cells[3].style.color = '#32F129';
                        }

                        // Check and mark green for total time
                        if (currentLapNum === bestLapNum) {
                            row.cells[4].style.color = '#32F129';
                        }
                    });
                } else {
                    const row = lapHistoryBody.insertRow();
                    row.innerHTML = '<td colspan="5">Lap History data not available</td>';
                }

                lapHistoryContent.appendChild(createAccordion('Lap History', lapHistoryTable));
                return lapHistoryContent;
            }

            function getErsHistoryContent(data) {

                const ersHistoryContent = document.createElement('div');
                const ersHistoryTable = document.createElement('table');
                ersHistoryTable.classList.add('ers-damage-table');
                const ersHistoryHeader = ersHistoryTable.createTHead();
                const ersHistoryHeaderRow = ersHistoryHeader.insertRow();
                ersHistoryHeaderRow.innerHTML = `
                    <th>Lap</th>
                    <th>ERS remaining</th>
                    <th>ERS deployed</th>
                    <th>Harvested - MGU-H</th>
                    <th>Harvested - MGU-K</th>
                    <th>Harvested - Total</th>
                `;
                const ersHistoryBody = ersHistoryTable.createTBody();
                if ("per-lap-info" in data) {
                    const perLapHistoryData = data["per-lap-info"];
                    if (perLapHistoryData.length > 0) {
                        perLapHistoryData.forEach((lap, index) => {
                            const row = ersHistoryBody.insertRow();
                            const currentLapNum = lap["lap-number"];
                            if (currentLapNum == 0) {
                                // Skip lap 0 for ERS, we want that only for fuel
                                return;
                            }
                            let ersRemainingPerc = "---";
                            let ersDeployedPerc = "---";
                            let ersHarvestedMguHPerc = "---";
                            let ersHarvestedMguKPerc = "---";
                            let ersHarvestedTotalPerc = "---";

                            if ("car-status-data" in lap) {
                                const maxErsCapacity = lap["car-status-data"]["ers-max-capacity"];
                                const ersRemainingVal = lap["car-status-data"]["ers-store-energy"];
                                const ersDeployedThisLapVal = lap["car-status-data"]["ers-deployed-this-lap"];
                                const ersHarvestedThisLapMguHVal = lap["car-status-data"]["ers-harvested-this-lap-mguh"];
                                const ersHarvestedThisLapMguKVal = lap["car-status-data"]["ers-harvested-this-lap-mguk"];

                                ersRemainingPerc = formatFloatWithTwoDecimals((ersRemainingVal / maxErsCapacity) * 100) + "%";
                                ersDeployedPerc = formatFloatWithTwoDecimals((ersDeployedThisLapVal / maxErsCapacity) * 100) + "%";
                                ersHarvestedMguHPerc = formatFloatWithTwoDecimals((ersHarvestedThisLapMguHVal / maxErsCapacity) * 100) + "%";
                                ersHarvestedMguKPerc = formatFloatWithTwoDecimals((ersHarvestedThisLapMguKVal / maxErsCapacity) * 100) + "%";
                                ersHarvestedTotalPerc = formatFloatWithTwoDecimals(((ersHarvestedThisLapMguHVal + ersHarvestedThisLapMguKVal) / maxErsCapacity) * 100) + "%";
                            }

                            row.innerHTML = `
                                <td>${currentLapNum}</td>
                                <td>${ersRemainingPerc}</td>
                                <td>${ersDeployedPerc}</td>
                                <td>${ersHarvestedMguHPerc}</td>
                                <td>${ersHarvestedMguKPerc}</td>
                                <td>${ersHarvestedTotalPerc}</td>
                            `;
                        });
                    } else {
                        const row = ersHistoryBody.insertRow();
                        row.innerHTML = '<td colspan="6">ERS History data not available</td>';
                    }
                } else {
                    const row = ersHistoryBody.insertRow();
                    row.innerHTML = '<td colspan="6">ERS History data not available</td>';
                }

                ersHistoryContent.appendChild(createAccordion('ERS History', ersHistoryTable));
                return ersHistoryContent;
            }

            function getFuelHistoryContent(data) {

                const fuelHistoryContent = document.createElement('div');
                const fuelHistoryTable = document.createElement('table');
                fuelHistoryTable.classList.add('fuel-damage-table');
                const fuelHistoryHeader = fuelHistoryTable.createTHead();
                const fuelHistoryHeaderRow = fuelHistoryHeader.insertRow();
                fuelHistoryHeaderRow.innerHTML = `
                    <th>Lap</th>
                    <th>Fuel Load (kg)</th>
                    <th>Fuel Load Delta</th>
                    <th>Excess Laps</th>
                    <th>Excess Laps Delta</th>
                `;
                const fuelHistoryBody = fuelHistoryTable.createTBody();
                if ("per-lap-info" in data) {
                    const perLapHistoryData = data["per-lap-info"];
                    if (perLapHistoryData.length > 0) {
                        perLapHistoryData.forEach((lap, index) => {
                            const row = fuelHistoryBody.insertRow();
                            const currentLapNum = lap["lap-number"];

                            let fuelLoad = "---";
                            let fuelLaps = "---";
                            let fuelLoadDelta = "---";
                            let fuelLapsDelta = "---";

                            if ("car-status-data" in lap) {
                                const fuelLoadVal = lap["car-status-data"]["fuel-in-tank"];
                                const fuelLapsVal = lap["car-status-data"]["fuel-remaining-laps"];

                                fuelLoad = formatFloatWithTwoDecimals(fuelLoadVal);
                                fuelLaps = formatFloatWithTwoDecimals(fuelLapsVal);


                                if (index > 0 && "car-status-data" in data["per-lap-info"][index-1]) {
                                    console.log("inside if. length: " + data["per-lap-info"].length + " index " + index);
                                    const fuelLoadValPrev = data["per-lap-info"][index-1]["car-status-data"]["fuel-in-tank"];
                                    const fuelLapsValPrev = data["per-lap-info"][index-1]["car-status-data"]["fuel-remaining-laps"];

                                    fuelLoadDelta = formatFloatWithTwoDecimalsSigned(fuelLoadValPrev - fuelLoadVal);
                                    fuelLapsDelta = formatFloatWithTwoDecimalsSigned(fuelLapsValPrev - fuelLapsVal);
                                }
                            }

                            row.innerHTML = `
                                <td>${currentLapNum}</td>
                                <td>${fuelLoad}</td>
                                <td>${fuelLoadDelta}</td>
                                <td>${fuelLaps}</td>
                                <td>${fuelLapsDelta}</td>
                            `;
                        });
                    } else {
                        const row = fuelHistoryBody.insertRow();
                        row.innerHTML = '<td colspan="6">ERS History data not available</td>';
                    }
                } else {
                    const row = fuelHistoryBody.insertRow();
                    row.innerHTML = '<td colspan="6">ERS History data not available</td>';
                }

                fuelHistoryContent.appendChild(createAccordion('Fuel History', fuelHistoryTable));
                return fuelHistoryContent;
            }

            function getTyreStintHistoryContent(data) {

                const tyreStintHistoryContent = document.createElement('div');
                const tyreStintHistoryTable = document.createElement('table');
                tyreStintHistoryTable.classList.add('tyre-stint-history-table');

                const tyreStintHistoryHeader = tyreStintHistoryTable.createTHead();
                const tyreStintHistoryHeaderRow = tyreStintHistoryHeader.insertRow();
                tyreStintHistoryHeaderRow.innerHTML = `
                    <th>Stint number</th>
                    <th>Start Lap</th>
                    <th>End Lap</th>
                    <th>Stint Length</th>
                    <th>Compound</th>
                    <th>Tyre Set ID</th>
                    <th>Tyre Wear</th>
                    <th>Tyre Wear Per Lap</th>
                `;

                const tyreStintHistoryBody = tyreStintHistoryTable.createTBody();
                if ("tyre-set-history" in data) {
                    const tyreStintHistoryData = data["tyre-set-history"];
                    tyreStintHistoryData.forEach((stintData, index) => {
                        const row = tyreStintHistoryBody.insertRow();
                        const stintId = index + 1;

                        const stintStartLap = stintData["start-lap"];
                        const stintEndLap = stintData["end-lap"];
                        const stintLength = `${stintData["stint-length"]} lap(s)`;
                        let compound = "---";
                        let tyreSetId = "---";
                        let tyreWear = "---";
                        let tyreWearPerLap = "---";

                        if ("tyre-set-data" in stintData) {
                            const tyreSetData = stintData["tyre-set-data"];
                            const tyreSetIndex = stintData["fitted-index"];

                            compound = tyreSetData["actual-tyre-compound"];
                            tyreSetId = `${compound} - ${tyreSetIndex}`;
                            tyreWear = `${tyreSetData["wear"]} %`;

                            // Use parseFloat to ensure numerical calculation
                            const wearPerLap = parseFloat(tyreSetData["wear"]) / parseFloat(stintData["stint-length"]);
                            tyreWearPerLap = formatFloatWithTwoDecimals(wearPerLap) + "%";
                        }

                        row.innerHTML = `
                            <td>${stintId}</td>
                            <td>${stintStartLap}</td>
                            <td>${stintEndLap}</td>
                            <td>${stintLength}</td>
                            <td>${compound}</td>
                            <td>${tyreSetId}</td>
                            <td>${tyreWear}</td>
                            <td>${tyreWearPerLap}</td>
                        `;
                    });
                } else {
                    const row = tyreStintHistoryBody.insertRow();
                    row.innerHTML = '<td colspan="8">Tyre Stint History data not available</td>';
                }
                tyreStintHistoryContent.appendChild(createAccordion('Tyre Stint History History', tyreStintHistoryTable));
                return tyreStintHistoryContent;
            }

            function getWarningsAndPenaltiesContent(data) {

                const warningsPenaltiesContent = document.createElement('div');
                const warningsPenaltiesTable = document.createElement('table');
                warningsPenaltiesTable.classList.add('warnings-penalties-damage-table');
                const warningsPenaltiesHeader = warningsPenaltiesTable.createTHead();
                const warningsPenaltiesHeaderRow = warningsPenaltiesHeader.insertRow();
                warningsPenaltiesHeaderRow.innerHTML = '<th>Type</th><th>Value</th>';
                const warningsPenaltiesBody = warningsPenaltiesTable.createTBody();
                if ("lap-data" in data) {
                    const lapData = data["lap-data"];
                    const numPenalties = lapData["penalties"];
                    const totalWarnings = lapData["total-warnings"];
                    const numCornerCuttingWarnings = lapData["corner-cutting-warnings"];
                    const numUnservedDriveThroughPens = lapData["num-unserved-drive-through-pens"];
                    const numUnservedStopGoPens = lapData["num-unserved-stop-go-pens"];

                    const row1 = warningsPenaltiesBody.insertRow();
                    row1.innerHTML = `
                        <td>Total penalties (time)</td>
                        <td>${numPenalties} sec</td>
                    `;

                    const row2 = warningsPenaltiesBody.insertRow();
                    row2.innerHTML = `
                        <td>Total warnings</td>
                        <td>${totalWarnings}</td>
                    `;

                    const row3 = warningsPenaltiesBody.insertRow();
                    row3.innerHTML = `
                        <td>Corner Cutting Warnings</td>
                        <td>${numCornerCuttingWarnings}</td>
                    `;

                    const row4 = warningsPenaltiesBody.insertRow();
                    row4.innerHTML = `
                        <td>Unserved Drive Through Penalties</td>
                        <td>${numUnservedDriveThroughPens}</td>
                    `;

                    const row5 = warningsPenaltiesBody.insertRow();
                    row5.innerHTML = `
                        <td>Unserved Stop Go Penalties</td>
                        <td>${numUnservedStopGoPens}</td>
                    `;

                    if (data["is-player"]) {
                        let naughtyStatus;
                        if (
                            numPenalties > 0 ||
                            totalWarnings > 0 ||
                            numCornerCuttingWarnings > 0 ||
                            numUnservedDriveThroughPens > 0 ||
                            numUnservedStopGoPens > 0
                        ) {
                            naughtyStatus = "Yes, You are naughty";
                        } else {
                            naughtyStatus = "Well, You may be naughty";
                        }
                        const row6 = warningsPenaltiesBody.insertRow();
                        row6.innerHTML = `
                            <td>Are you naughty?</td>
                            <td>${naughtyStatus}</td>
                        `;
                    }
                } else {
                    const row = warningsPenaltiesBody.insertRow();
                    row.innerHTML = '<td colspan="2">Tyre Wear data not available</td>';
                }
                warningsPenaltiesContent.appendChild(createAccordion('Warnings & Penalties', warningsPenaltiesTable));
                return warningsPenaltiesContent;
            }

            // Car Damage Table
            modalContent.appendChild(getCarDamageContent(data));

            // Tyre Damage Table
            modalContent.appendChild(getTyreDamageContent(data));

            // Tyre Wear Table
            modalContent.appendChild(getTyreWearContent(data));

            // Lap History Table
            modalContent.appendChild(getLapHistoryContent(data));

            // ERS history
            modalContent.appendChild(getErsHistoryContent(data));

            // Fuel history
            modalContent.appendChild(getFuelHistoryContent(data));

            // Tyre Stint History
            modalContent.appendChild(getTyreStintHistoryContent(data));

            // Warning and Penalties Table
            modalContent.appendChild(getWarningsAndPenaltiesContent(data));

            // Finalise the data
            const modalTitle = document.getElementById('modalTitle');
            modalTitle.innerText = `Driver Information - ${data["driver-name"]}`;

            const modal = document.getElementById('driverInfoModal');
            modal.style.display = 'block';
        }


        function closeDriverInfoModal() {
            const modal = document.getElementById('driverInfoModal');
            modal.style.display = 'none';
        }

        function updateGlobalInfo(circuit, event_type, track_temp, curr_lap, total_laps,
            safety_car_status, fastest_lap, pit_speed_limit, packet_capture_enabled) {

            document.getElementById('tableTitle').textContent = `${event_type} - ${circuit}`;
            document.getElementById('trackTemperature').textContent = `Track Temperature: ${track_temp}°C`;
            document.getElementById('lapInformation').textContent = `Lap: ${curr_lap}/${total_laps}`;
            document.getElementById('safetyCarStatus').textContent = `Safety Car Status: ${safety_car_status}`;
            document.getElementById('fastestLapOverall').textContent = `Fastest Lap Overall: ${fastest_lap}`;
            document.getElementById('pitSpeedLimit').textContent = `Pit Lane Speed Limit: ${pit_speed_limit}`;

            const saveTelemetryLink = document.getElementById('saveTelemetryLink');
            saveTelemetryLink.style.display = packet_capture_enabled ? 'inline' : 'none';
        }

        function updateLocalTime() {
            const now = new Date();
            const options = {
                hour12: !is24HourFormat
            };
            const timeString = now.toLocaleTimeString('en-US', options);
            document.getElementById('localTime').textContent = `Local Time: ${timeString}`;
        }

        function toggleTimeFormat() {
            is24HourFormat = !is24HourFormat;
            updateLocalTime();
        }

        function formatFileSize(bytes) {
            const sizes = ['Bytes', 'kB', 'MB', 'GB', 'TB'];

            if (bytes === 0) return '0 Byte';

            const i = parseInt(Math.floor(Math.log(bytes) / Math.log(1024)));
            const sizeUnit = sizes[Math.min(i, sizes.length - 1)];
            const formattedSize = Math.round((bytes / Math.pow(1024, i)) * 100) / 100;

            return `${formattedSize} ${sizeUnit}`;
        }

        document.getElementById("saveTelemetryLink").addEventListener("click", function () {
            fetch('/save-telemetry-capture')
                .then(response => response.json())
                .then(data => {
                    if (data['status-code'] === 'SUCCESS') {
                        const formattedFileSize = formatFileSize(data['num-bytes']);
                        const numPacketsWithCommas = data['num-packets'].toLocaleString();

                        Swal.fire({
                            icon: 'success',
                            title: 'Telemetry captured!',
                            html: `Written to file: ${data['file-name']}.<br>${numPacketsWithCommas} packets written.<br>File size: ${formattedFileSize}.`,
                        });
                    } else if (data['status-code'] === 'DISABLED') {
                        Swal.fire({
                            icon: 'info',
                            title: 'Telemetry capture is disabled!',
                            text: 'Please enable telemetry capture.',
                        });
                    } else {
                        if (data["num-packets"] === 0) {
                            Swal.fire({
                                icon: 'error',
                                title: 'Error capturing telemetry!',
                                text: 'There is no data available to write to file',
                            });
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'Error capturing telemetry!',
                                text: JSON.stringify(data),
                            });
                        }
                    }
                })
                .catch(error => {
                    console.error('Error fetching telemetry capture details:', error);
                    Swal.fire({
                        icon: 'error',
                        title: 'Error fetching telemetry capture details!',
                        text: 'Please check the console for more information.',
                    });
                });
        });

        document.getElementById("getOvertakeInfo").addEventListener("click", function () {
            fetch('/overtake-info')
                .then(response => response.json())
                .then(data => {

                    if (data['status-code'] === 'SUCCESS') {
                        const overtakeInfo = data['overtake-info'];
                        const formattedOvertakeInfo = overtakeInfo.map(info => `${info['driver']} overtakes ${info['overtaken-driver']} at lap ${info['lap']}`);
                        const formattedOvertakeList = formattedOvertakeInfo.join('<br>');

                        Swal.fire({
                            icon: 'info',
                            title: 'Overtake Information',
                            html: formattedOvertakeList,
                            confirmButtonText: 'OK',
                        });
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error fetching overtake information!',
                            text: JSON.stringify(data),
                        });
                    }
                })
                .catch(error => {
                    console.error('Error fetching overtake information:', error);
                    Swal.fire({
                        icon: 'error',
                        title: 'Error fetching overtake information!',
                        text: 'Please check the console for more information.',
                    });
                });
        });

        // Add an event listener to the hyperlink
        document.getElementById('localTime').addEventListener('click', toggleTimeFormat);

        // Fetch data at intervals specified from jinja
        setInterval(fetchDataAndDisplay, {{ client_poll_interval_ms | tojson | safe }});

        // Update local time every second
        setInterval(updateLocalTime, 1000);

        // Initial fetch and display
        fetchDataAndDisplay();
        updateLocalTime();

    </script>
</body>

</html>