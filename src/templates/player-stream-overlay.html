<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pits n' Giggles Stream Overlay</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/weather.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/tyreIcons.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/carTelemetryOverlay.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/gForceOverlay.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/conditions.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/speedLimit.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Exo+2:ital,wght@0,100..900;1,100..900&display=swap"
        rel="stylesheet">
    <!-- Include Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-streaming"></script> -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/socket.io/4.4.1/socket.io.min.js"></script>
    <style>
        /* Make the body take up the full height */
        html,
        body {
            height: 100%;
            margin: 0;
        }

        body {
            font-family: 'Exo 2', sans-serif;
            background-color: transparent;
            /* Keeps it overlay-ready */
            color: var(--f1-text, #ffffff);
            /* Default to white text if --f1-text is not defined */
            line-height: 1.5;
            min-height: 100vh;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.8);
            /* Adds a shadow for better contrast on bright or dynamic backgrounds */
            margin: 0;
            /* Removes default margins for a cleaner overlay */
            padding: 0;
            /* Ensures no unwanted spacing */
            box-sizing: border-box;
            /* Keeps sizing predictable */
        }


        /* Make container take up the full height */
        .container-fluid {
            height: 100%;
        }

        /* Ensure that rows take up equal height */
        .row.full-height {
            height: 50%;
            /* 50% of the screen height for each row */
        }

        /* Ensure that columns inside each row stretch to fill space */
        .col {
            display: flex;
            align-items: center;
            justify-content: center;
            border: 4px solid #333;
            /* Thicker border (4px solid) */
        }

        .text-purple {
            background-color: #800080;
        }
    </style>
</head>

<body>

    <div class="container-fluid d-flex flex-column">
        <!-- First Row -->
        <div class="row full-height">
            <!-- Lap time history div -->
            <div class="col d-flex align-items-center justify-content-center" id="lapTimeDiv">
                <table class="table table-striped table-bordered table-dark" id="lapTimeTable"></table>
            </div>

            <!-- Penalties/Stats Div new -->
            <div class="col d-flex align-items-center justify-content-center">
                <div class="conditions">
                    <div class="condition-item">
                        <i class="fa-solid fa-road condition-icon"></i>
                        <span id="track-temp" class="condition-value"></span>
                    </div>
                    <div class="condition-item">
                        <i class="bi bi-thermometer-half condition-icon"></i>
                        <span id="air-temp" class="condition-value"></span>
                    </div>
                    <div class="condition-item">
                        <i class="bi bi-exclamation-triangle condition-icon"></i>
                        <span id="track-limits-warnings" class="condition-value"></span>
                    </div>
                    <div class="condition-item">
                        <div id="pit-speed-limit" class="speed-limit-sign"></div>
                    </div>

                </div>
            </div>

            <!-- Weather div -->
            <div class="col d-flex align-items-center justify-content-center weather-forecast" id="weatherDiv">
            </div>
        </div>
        <!-- Second Row -->
        <div class="row full-height">
            <!-- G Force div -->
            <div class="col d-flex align-items-center justify-content-center" id="gForceDiv">
                <!-- G-Force Display Template -->
                <div id="gforce-display" class="gforce-display">
                    <div id="gforce-circle" class="gforce-circle">
                        <div id="gforce-dot" class="gforce-dot"></div>
                        <div class="gforce-crosshair">
                            <div class="crosshair-vertical"></div>
                            <div class="crosshair-horizontal"></div>
                        </div>
                    </div>
                    <div class="gforce-text mt-2">
                        <div class="mt-1">
                            <small>
                                <span id="net-gforce"></span>
                            </small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Car telemetry div -->
            <div class="col d-flex align-items-center justify-content-center carTelemetryContainer">
                <div id="CarTelemetryWidget" class="telemetry-widget">
                    <div class="car-telemetry-section">
                        <div id="brakeContainer" class="telemetry-pedal-container">
                            <div id="brakeBar" class="telemetry-pedal telemetry-brake"></div>
                        </div>

                        <div class="car-telemetry-chart-section">
                            <div id="steeringContainer" class="telemetry-steering-container">
                                <div class="telemetry-steering-center"></div>
                                <div id="steeringBar" class="telemetry-steering-indicator"></div>
                            </div>

                            <div class="telemetry-chart-container">
                                <canvas id="throttleBrakeChart"></canvas>
                            </div>
                        </div>

                        <div id="throttleContainer" class="telemetry-pedal-container">
                            <div id="throttleBar" class="telemetry-pedal telemetry-throttle"></div>
                        </div>
                    </div>
                </div>

            </div>

            <!-- TODO: Notification -->
            <div class="col d-flex align-items-center justify-content-center">
                Top row: Lap time history, general stats, weather<br />
                Bottom row: G force, input telemetry, unused<br />
            </div>
        </div>
    </div>

    <!-- Include Bootstrap JS (optional, for interactive components) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/utils.js') }}"></script>
    <script src="{{ url_for('static', filename='js/weatherUI.js') }}"></script>
    <script src="{{ url_for('static', filename='js/lapTimeHistoryOverlay.js') }}"></script>
    <script src="{{ url_for('static', filename='js/penaltiesStatsOverlay.js') }}"></script>
    <script src="{{ url_for('static', filename='js/gForceOverlay.js') }}"></script>
    <script src="{{ url_for('static', filename='js/carTelemetryOverlay.js') }}"></script>
    <script>
        const sampleStreamOverlayJSON = {
            "car-telemetry": {
                "brake": 0,
                "steering": -0.8164450526237488,
                "throttle": 100
            },
            "f1-game-year": 24,
            "g-force": {
                "lat": 0.36567622423171997,
                "long": 0.37355566024780273,
                "vert": 0.06564931571483612
            },
            "lap-time-history": {
                "fastest-lap-number": 5,
                "fastest-s1-lap-number": 4,
                "fastest-s2-lap-number": 5,
                "fastest-s3-lap-number": 4,
                "global-fastest-lap-ms": 66622,
                "global-fastest-s1-ms": 16246,
                "global-fastest-s2-ms": 29718,
                "global-fastest-s3-ms": 20204,
                "lap-time-history-data": [
                    {
                        "lap-number": 1,
                        "lap-time-in-ms": 73077,
                        "lap-time-str": "01:13.077",
                        "lap-valid-bit-flags": 15,
                        "sector-1-time-in-ms": 21421,
                        "sector-1-time-minutes": 0,
                        "sector-1-time-str": "21.421",
                        "sector-2-time-in-ms": 30456,
                        "sector-2-time-minutes": 0,
                        "sector-2-time-str": "30.456",
                        "sector-3-time-in-ms": 21199,
                        "sector-3-time-minutes": 0,
                        "sector-3-time-str": "21.199",
                        "tyre-set-info": {
                            "actual-tyre-compound": "C5",
                            "tyre-age-laps": 0,
                            "tyre-set-id": 6,
                            "visual-tyre-compound": "Soft"
                        }
                    },
                    {
                        "lap-number": 2,
                        "lap-time-in-ms": 67820,
                        "lap-time-str": "01:07.820",
                        "lap-valid-bit-flags": 15,
                        "sector-1-time-in-ms": 17104,
                        "sector-1-time-minutes": 0,
                        "sector-1-time-str": "17.104",
                        "sector-2-time-in-ms": 30392,
                        "sector-2-time-minutes": 0,
                        "sector-2-time-str": "30.392",
                        "sector-3-time-in-ms": 20323,
                        "sector-3-time-minutes": 0,
                        "sector-3-time-str": "20.323",
                        "tyre-set-info": {
                            "actual-tyre-compound": "C5",
                            "tyre-age-laps": 1,
                            "tyre-set-id": 6,
                            "visual-tyre-compound": "Soft"
                        }
                    },
                    {
                        "lap-number": 3,
                        "lap-time-in-ms": 66931,
                        "lap-time-str": "01:06.931",
                        "lap-valid-bit-flags": 15,
                        "sector-1-time-in-ms": 16590,
                        "sector-1-time-minutes": 0,
                        "sector-1-time-str": "16.590",
                        "sector-2-time-in-ms": 30091,
                        "sector-2-time-minutes": 0,
                        "sector-2-time-str": "30.091",
                        "sector-3-time-in-ms": 20249,
                        "sector-3-time-minutes": 0,
                        "sector-3-time-str": "20.249",
                        "tyre-set-info": {
                            "actual-tyre-compound": "C5",
                            "tyre-age-laps": 3,
                            "tyre-set-id": 6,
                            "visual-tyre-compound": "Soft"
                        }
                    },
                    {
                        "lap-number": 4,
                        "lap-time-in-ms": 66884,
                        "lap-time-str": "01:06.884",
                        "lap-valid-bit-flags": 15,
                        "sector-1-time-in-ms": 16350,
                        "sector-1-time-minutes": 0,
                        "sector-1-time-str": "16.350",
                        "sector-2-time-in-ms": 30329,
                        "sector-2-time-minutes": 0,
                        "sector-2-time-str": "30.329",
                        "sector-3-time-in-ms": 20204,
                        "sector-3-time-minutes": 0,
                        "sector-3-time-str": "20.204",
                        "tyre-set-info": {
                            "actual-tyre-compound": "C5",
                            "tyre-age-laps": 3,
                            "tyre-set-id": 6,
                            "visual-tyre-compound": "Soft"
                        }
                    },
                    {
                        "lap-number": 5,
                        "lap-time-in-ms": 66622,
                        "lap-time-str": "01:06.622",
                        "lap-valid-bit-flags": 15,
                        "sector-1-time-in-ms": 16395,
                        "sector-1-time-minutes": 0,
                        "sector-1-time-str": "16.395",
                        "sector-2-time-in-ms": 29983,
                        "sector-2-time-minutes": 0,
                        "sector-2-time-str": "29.983",
                        "sector-3-time-in-ms": 20243,
                        "sector-3-time-minutes": 0,
                        "sector-3-time-str": "20.243",
                        "tyre-set-info": {
                            "actual-tyre-compound": "C5",
                            "tyre-age-laps": 5,
                            "tyre-set-id": 6,
                            "visual-tyre-compound": "Soft"
                        }
                    }
                ]
            },
            "penalties-and-stats": {
                "air-temperature": 22,
                "circuit": "Austria",
                "corner-cutting-warnings": 0,
                "num-collisions": 5,
                "pit-speed-limit": 80,
                "speed-trap-record": 319.41497802734375,
                "time-penalties": 0,
                "total-warnings": 0,
                "track-temperature": 32,
                "unserved-drive-through-pens": 0,
                "unserved-stop-go-pens": 0
            },
            "tyre-wear": {
                "current": {
                    "average": 12.315814018249512,
                    "desc": "Curr tyre wear",
                    "front-left-wear": 10.466483116149902,
                    "front-right-wear": 13.985130310058594,
                    "lap-number": 5,
                    "rear-left-wear": 12.046117782592773,
                    "rear-right-wear": 12.765524864196777
                },
                "pit-window": 0,
                "predictions": []
            },
            "weather-forecast-samples": [
                {
                    "rain-probability": 18,
                    "time-offset": 0,
                    "weather": "Overcast"
                },
                {
                    "rain-probability": 18,
                    "time-offset": 5,
                    "weather": "Overcast"
                },
                {
                    "rain-probability": 18,
                    "time-offset": 10,
                    "weather": "Overcast"
                }
            ]
        };
        let firstDataReceived = false;
        const socket = io();
        const carTelemetryWidget = new CarTelemetryWidget('CarTelemetryWidget');
        const gForceDisplayWidget = new GForceDisplay('gforce-display');
        const weatherWidget = new WeatherWidget(document.getElementById('weatherDiv'));
        const pensStatsWidget = new PenaltiesStatsWidget();
        const lapTimesWidget = new LapTimeTableWidget();

        const maxWeatherSamples = 5;
        // Emit a custom event to register client type upon connection
        socket.on('connect', function () {
            socket.emit('register-client', { type: 'player-stream-overlay' });
        });

        socket.on('player-overlay-update', function (data) {
            if (!firstDataReceived && data["f1-game-year"] !== null) {
                firstDataReceived = true;
            }
            if (!firstDataReceived) {
                if (data["f1-game-year"] === null) {
                    data = sampleStreamOverlayJSON;
                } else {
                    firstDataReceived = true;
                }
            }

            // Update the widgets with the actual data
            carTelemetryWidget.update(data["car-telemetry"]);
            pensStatsWidget.update(data["penalties-and-stats"], data["f1-game-year"]);
            lapTimesWidget.update(data["lap-time-history"]);
            weatherWidget.update(data["weather-forecast-samples"].slice(0, maxWeatherSamples + 1));
            gForceDisplayWidget.update(data["g-force"]);
        });
    </script>
</body>

</html>